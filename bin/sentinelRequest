#!/usr/bin/env python
# -*- coding: utf-8 -*-
from __future__ import print_function
import os,sys
import datetime
import logging
import argparse

from sentinelRequest import scihubQuery_new as scihubQuery
from sentinelRequest import  logger
import geopandas as gpd
import shapely.wkt as wkt

#logging.basicConfig()
#logger = logging.getLogger(os.path.basename(__file__))
#logger.setLevel(logging.INFO)


if __name__ == "__main__":
    dateformat="%Y-%m-%d %H:%M"
    dtime=3
    filename="S1*"
    ddeg=0.1
    fionaDrivers = {
        'csv' : 'CSV',
        'shp' : 'ESRI Shapefile',
        'gpkg': 'GPKG',
        'kml' : 'KML',
        'json': 'GeoJSON'
        }
    
    description = "Requests SAFE list from scihub"

    parser = argparse.ArgumentParser(description = description)

    parser.add_argument("--user",action="store",default="guest",type=str,help="scihub login")
    parser.add_argument("--password",action="store",default="guest",type=str,help="scihub password")
    parser.add_argument("--date",action="append",default=None, nargs=1,  type=str,help="date as string. if provided 2 time, first is start, last is stop")
    parser.add_argument("--wkt",action="store",default=None, type=str,help="wkt representation of the region of interest")
    parser.add_argument("--filename",action="store",default=filename,type=str,help="filename, with joker. ex 'S1?_?W_GRD*'. default to %s" % filename)
    parser.add_argument("--query",action="store",default=None,type=str,help="""additionnal query. for exemple 'orbitdirection:ASCENDING AND polarisationmode:"VV VH"'""")
    parser.add_argument("--datatake",action="store_true",help="retrieve the whole datatake (ie adjacent SAFEs)")
    parser.add_argument("--dateformat",action="store",default=dateformat,  type=str,help="strftime date format. default: %%Y-%%m-%%d %%H:%%M" )
    parser.add_argument("--dtime",action="store",default=dtime,type=int,help="dtime in hours, if --date has only one date. default to %d" % dtime)
    #parser.add_argument("--ddeg", action="store",default=[ddeg],nargs=1,type=float,help="ddeg in deg, if --coord has only one lon,lat. default to %3.2f" % ddeg)
    #parser.add_argument("--ql",action="store_true",help="download quicklook")
    parser.add_argument("--cachedir",action="store",default=None,help="cache dir to speedup requests")
    parser.add_argument("--cacherefreshrecent",action="store",default=7,type=int,help="ignore cache if date is more recent than n days ago")
    parser.add_argument("--cols",action="store",default="filename",type=str,help="field output, comma separated")
    parser.add_argument("--outfile",action="store",default=None,type=str,help="outfile")
    parser.add_argument("--outfile_format",action="store",default=None,type=str,help="outfile format. default from file ext. see driver option in geopandas.to_file")
    parser.add_argument("--show",action="store_true",help="show map with matplotlib")
    

    args = parser.parse_args()
    
    if sys.gettrace():
        logger.setLevel(logging.DEBUG)
        logger.debug("Activating debug messages")
    date = None
    if args.date:
        date=[ datetime.datetime.strptime(d[0],args.dateformat) for d in args.date]
    
    if args.wkt:
        geometry=wkt.loads(args.wkt)
    else:
        geometry=None
    
    
    try:
        query=args.query
    except:
        query=None
        
    gdf = gpd.GeoDataFrame({
        "beginposition" : date[0],
        "endposition"   : date[1],
        "geometry"      : geometry    
    },index=[0])
    
    result=scihubQuery(gdf,dtime=datetime.timedelta(hours=args.dtime),filename=args.filename,query=query,datatake=args.datatake,user=args.user,password=args.password,show=args.show,cachedir=args.cachedir,cacherefreshrecent=datetime.timedelta(days=args.cacherefreshrecent))
    cols=args.cols.split(',')
    try:
        result=result[cols]
    except:
        raise ValueError("bad cols. Available are %s" % result.keys())
        
    logger.info("Total : %s SAFES" % len(result))
    if args.outfile:
        # https://github.com/geopandas/geopandas/pull/728 and https://gis.stackexchange.com/questions/281895/changing-shapefiles-field-type-using-fiona/281941#281941
        # need to modify shema for datetime
        schema = gpd.io.file.infer_schema(result)
        if 'beginposition' in result:
            schema['properties']['beginposition'] = 'datetime'
        if 'endposition' in result:
            schema['properties']['endposition'] = 'datetime'
        
        # fiona driver
        import fiona
        fiona.supported_drivers['KML'] = 'rw'
        if args.outfile_format is None:
            fileext=os.path.splitext(args.outfile)[1][1:]
            try:
                args.outfile_format = fionaDrivers[fileext]
            except:
                raise ValueError("unknown ext %s. please use --outfile_format" % fileext)
        if args.outfile_format not in fiona.supported_drivers:
            raise ValueError("available outfile_format : %s" % (fiona.supported_drivers ))
            
        result.to_file(args.outfile,driver=args.outfile_format,schema=schema)
            
        logger.info("%s dumped as %s" % (args.outfile , args.outfile_format))
    else:
        sys.stdout.write(result.to_csv(index=False,sep='|'))
    
    
